on:
  workflow_call:
    inputs:
      is_pr:
        type: boolean
        default: false
      ios:
        default: "^18"
        required: false
        type: string
      xcode:
        default: "^16"
        required: false
        type: string
      macos:
        default: macos-latest
        required: false
        type: string
      test-retry-iterations:
        description: "Max retries per test on failure (0 = no retry). Uses xcodebuild -retry-tests-on-failure -test-iterations."
        default: 3
        required: false
        type: number
      test_suite:
        description: "Test class to run only (e.g. ECALoginTests). Empty = run all. Ignored when is_pr (PR runs single smoke test)."
        default: ""
        required: false
        type: string
      destination:
        description: "xcodebuild -destination (e.g. 'platform=iOS Simulator,name=iPhone 17,OS=26.0'). Empty = use default for iOS 18."
        default: ""
        required: false
        type: string
      parallel-testing-worker-count:
        description: "xcodebuild -parallel-testing-worker-count (0 = do not set; parallel testing uses xcodebuild default)."
        default: 6
        required: false
        type: number

jobs:
  test-ui:
    runs-on: ${{ inputs.macos }}
    steps:
      - uses: actions/checkout@v4
        if: ${{ inputs.is_pr }}
        with:
          fetch-depth: 100
          ref: ${{ github.event.pull_request.head.sha }}
      - uses: actions/checkout@v4
        if: ${{ !inputs.is_pr }}
        with:
          ref: ${{ github.head_ref }}
      - name: Install Dependencies
        env:
          UI_TEST_CONFIG: ${{ secrets.UI_TEST_CONFIG }}
        run: |
          ./install.sh
          echo "$UI_TEST_CONFIG" > ./shared/test/ui_test_config.json
      - name: Install iOS 17 runtime if needed
        if: ${{ inputs.ios == '^17' }}
        run: xcodes runtimes install "iOS 17.5"
      # Select Xcode only (mxcl action does not support -retry-tests-on-failure)
      - uses: mxcl/xcodebuild@v3
        with:
          xcode: ${{ inputs.xcode }}
          platform: iOS
          platform-version: ${{ inputs.ios }}
          action: none
      - name: Resolve simulator destination
        id: resolve_destination
        run: |
          if [ -n "${{ inputs.destination }}" ]; then
            echo "destination=${{ inputs.destination }}" >> "$GITHUB_OUTPUT"
          else
            UID=$(xcrun simctl list devices available -j | python3 -c '
          import sys, json
          d = json.load(sys.stdin)
          for devices in d.get("devices", {}).values():
            for dev in devices:
              if dev.get("isAvailable", True) and "iPhone" in dev.get("name", ""):
                print(dev["udid"])
                sys.exit(0)
          sys.exit(1)
            ')
            if [ -z "$UID" ]; then
              echo "::error::No available iPhone simulator found"
              exit 1
            fi
            echo "destination=platform=iOS Simulator,id=$UID" >> "$GITHUB_OUTPUT"
          fi
      - name: Run UI tests
        id: xcodebuild
        run: |
          DESTINATION="${{ steps.resolve_destination.outputs.destination }}"
          RETRY_ARGS=()
          if [ "${{ inputs.test-retry-iterations }}" -gt 0 ]; then
            RETRY_ARGS=(-retry-tests-on-failure -test-iterations "${{ inputs.test-retry-iterations }}")
          fi
          ONLY_TESTING_ARGS=()
          if [ "$IS_PR" = "true" ]; then
            ONLY_TESTING_ARGS=(-only-testing 'AuthFlowTesterUITests/ECALoginTests/testECAAdvancedJwt_DefaultScopes')
          elif [ -n "${{ inputs.test_suite }}" ]; then
            ONLY_TESTING_ARGS=(-only-testing "AuthFlowTesterUITests/${{ inputs.test_suite }}")
          fi
          PARALLEL_ARGS=()
          if [ "${{ inputs.parallel-testing-worker-count }}" -gt 0 ]; then
            PARALLEL_ARGS=(-parallel-testing-enabled YES -parallel-testing-worker-count "${{ inputs.parallel-testing-worker-count }}")
          fi
          xcodebuild test \
            -workspace SalesforceMobileSDK.xcworkspace \
            -scheme AuthFlowTester \
            -destination "$DESTINATION" \
            "${PARALLEL_ARGS[@]}" \
            "${ONLY_TESTING_ARGS[@]}" \
            "${RETRY_ARGS[@]}" \
            -resultBundlePath test \
            -enableCodeCoverage YES \
            | xcbeautify
        env:
          CODE_COVERAGE: YES
          IS_PR: ${{ inputs.is_pr }}
      - name: Parse test results
        if: success() || failure()
        run: |
          brew install xcresultparser
          mkdir -p firebase_results
          SUITE="${{ inputs.test_suite }}"
          [ -z "$SUITE" ] && SUITE=all
          [ "$IS_PR" = "true" ] && SUITE=pr
          xcresultparser -o junit test.xcresult > firebase_results/authflowtester-ui-${SUITE}-test_result.xml
      - name: Test Report
        uses: mikepenz/action-junit-report@v5
        if: success() || failure()
        with:
          check_name: AuthFlowTester UI Test Results ${{ inputs.test_suite && format('({0})', inputs.test_suite) || '' }}
          job_name: AuthFlowTester UI Test Results ${{ inputs.test_suite && format('({0})', inputs.test_suite) || '' }}
          require_tests: true
          check_retries: true
          flaky_summary: true
          fail_on_failure: true
          group_reports: false
          include_passed: true
          include_empty_in_summary: false
          simplified_summary: true
          job_summary: ${{ steps.xcodebuild.outcome == 'failure' }}
          report_paths: 'firebase_results/**.xml'
      - uses: codecov/codecov-action@v4
        if: success() || failure()
        with:
          flags: AuthFlowTesterUI
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      - name: Upload test results artifact
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-authflowtester-ui-${{ inputs.test_suite || 'all' }}-ios${{ inputs.ios }}
          path: firebase_results/
